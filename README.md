# DTS to FLAC Converter

Компактный конвертер аудиодорожек DTS-HD MA 5.1 в FLAC 7.1 с веб-интерфейсом, написанный на Go.

## Особенности

- **Компактная архитектура**: Всё в одном контейнере - backend + frontend встроены в Go бинарник
- **Точная конвертация**: Преобразование DTS-HD MA 5.1 в FLAC 7.1 с сохранением качества
- **Высокая производительность**: Нативный Go код с низким потреблением памяти (5-15MB)
- **Real-time мониторинг**: WebSocket для отслеживания прогресса FFmpeg в реальном времени
- **Управление очередью**: Отдельные секции для текущей конвертации, очереди и истории
- **Отмена конвертации**: Возможность отменить текущую задачу
- **Автоматический бэкап**: Исходные файлы переименовываются в .bak после успешной конвертации
- **Простое развертывание**: Один Docker контейнер, без nginx
- **Сохранение структуры**: Конвертированные файлы сохраняются в те же директории

## Быстрый старт

### 1. Клонирование и настройка

```bash
git clone https://github.com/kex1k/ultimate-dts-fix-server.git
cd ultimate-dts-fix-server
```

### 2. Подготовка директорий

```bash
# Создаем директории для сервиса
mkdir -p data logs

# Создаем директории для медиафайлов (пример)
mkdir -p /path/to/media/library1
mkdir -p /path/to/media/library2
mkdir -p /path/to/media/library3
```

### 3. Настройка docker-compose.yml

Отредактируйте файл `docker-compose.yml`, заменив пути к вашим медиатекам:

```yaml
volumes:
  # Замените на ваши реальные пути
  - /your/real/path/library1:/media/library1
  - /your/real/path/library2:/media/library2
  - /your/real/path/library3:/media/library3
```

### 4. Запуск сервиса

```bash
# Запуск сервиса
docker-compose up -d

# Проверка статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f
```

### 5. Проверка работоспособности

```bash
# Открытие веб-интерфейса
# http://localhost:6969

# Проверка API (если нужно)
curl http://localhost:6969/api/status
```

## Конфигурация

### Переменные окружения

Создайте файл `.env` на основе `.env.example`:

```bash
GIN_MODE=release
DATABASE_PATH=/app/data/database.sqlite
LOG_LEVEL=info
PORT=3001
```

### Настройка медиатек

Система поддерживает любое количество медиатек. Добавьте их в `docker-compose.yml`:

```yaml
volumes:
  - /path/to/your/media1:/media/media1
  - /path/to/your/media2:/media/media2
  - /path/to/your/media3:/media/media3
```

## Использование

### Веб-интерфейс

1. **Откройте веб-интерфейс**: http://localhost:6969

2. **Поиск и добавление файлов**:
   - Введите regex паттерн для поиска (по умолчанию: `DTS.*5\.1`)
   - Нажмите "Искать" для поиска файлов
   - Кликните на файл в результатах для добавления в очередь

3. **Мониторинг**:
   - **Текущая конвертация**: Показывает активную задачу с выводом FFmpeg
   - **Очередь конвертации**: Список ожидающих задач
   - **История конвертаций**: Завершенные задачи с временем и статусом

4. **Управление**:
   - Кнопка "Отменить" для остановки текущей конвертации
   - Кнопка "Удалить" для удаления задачи из очереди
   - Логи в реальном времени внизу страницы

### Конвертация файлов

Система автоматически:
- Конвертирует DTS-HD MA 5.1 в FLAC 7.1
- Переименовывает файл: `movie.DTS-HD.5.1.mkv` → `movie.FLAC.7.1.mkv`
- Переименовывает исходный файл в `.bak` после успешной конвертации
- Сохраняет видео и субтитры без изменений

### API

Приложение использует **WebSocket для всего взаимодействия**:

```
ws://localhost:6969/ws
```

**Основные команды:**
- `search_files` - поиск файлов по regex
- `add_task` - добавить файл в очередь
- `cancel_task` - отменить конвертацию
- `delete_task` - удалить задачу
- `get_state` - получить текущее состояние

**Уведомления:**
- `initial_state` - начальное состояние при подключении
- `queue_update` - изменения в очереди
- `conversion_progress` - прогресс конвертации
- `log` - системные логи

Подробная документация: [`WEBSOCKET_API.md`](WEBSOCKET_API.md)

## Технические детали

### Команда FFmpeg

```bash
ffmpeg -i input.mkv \
  -c:v copy \
  -c:s copy \
  -c:a:0 flac \
  -b:a 384k \
  -map 0 \
  -compression_level 8 \
  -channel_layout 7.1 \
  -ac 8 \
  -af "pan=7.1|FL=FL|FR=FR|FC=FC|LFE=LFE|BL=SL|BR=SR|SL=SL|SR=SR" \
  output.mkv
```

### Особенности реализации

- **WebSocket-only API**: Всё взаимодействие через один WebSocket endpoint
- **Embedded Static Files**: Статические файлы встроены в Go бинарник через embed
- **Single Container**: Один контейнер вместо двух (backend + nginx)
- **Real-time Updates**: Мгновенные обновления без polling
- **Throttling**: Обновления прогресса отправляются раз в 2 секунды
- **Cancellation**: Использует Go context для корректной отмены FFmpeg процессов
- **Thread Safety**: Mutex защита для активной задачи
- **Security**: WebSocket origin validation для предотвращения CSRF
- **Database**: JSON файл для хранения истории задач

## Решение проблем

### Порт 6969 занят

Измените порт в `docker-compose.yml`:

```yaml
ports:
  - "6970:3001"  # Используйте другой порт
```

### Проблемы с правами доступа

```bash
# Даем права на запись медиатекам
chmod 755 /path/to/media/library1

# Или измените user в docker-compose.yml
user: "1000:1000"  # Замените на ваши UID:GID
```

### Проверка монтирования томов

```bash
# Проверяем внутри контейнера
docker-compose exec dts-converter ls -la /media/
```

### FFmpeg не найден

```bash
# Пересоберите образ
docker-compose build --no-cache
```

### WebSocket не подключается

Проверьте что:
- Контейнер запущен и доступен на порту 6969
- В браузере нет ошибок CORS
- Порт не заблокирован файрволом

## Мониторинг

```bash
# Статус контейнеров
docker-compose ps

# Использование ресурсов
docker stats

# Логи в реальном времени
docker-compose logs -f
```

## Остановка сервиса

```bash
# Остановка
docker-compose down

# Остановка с удалением томов
docker-compose down -v

# Остановка и удаление образов
docker-compose down --rmi all
```

## Производительность

- **Память**: 5-15 MB (Go процесс + встроенная статика)
- **CPU**: Зависит от FFmpeg (обычно 1-2 ядра)
- **Диск**: Требуется свободное место ~2x размера исходного файла
- **Скорость**: Зависит от размера файла и CPU (обычно 0.5-2x realtime)
- **Размер образа**: ~50-60 MB (Alpine + FFmpeg + Go бинарник)

## Безопасность

- WebSocket origin validation
- Поиск файлов только по regex паттерну
- Ручное добавление файлов через веб-интерфейс
- Изолированный Docker контейнер
- Минимальные права доступа
- Статические файлы встроены в бинарник (нет внешних зависимостей)

## Обновление

```bash
# Получить последние изменения
git pull

# Пересобрать и перезапустить
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## Известные ограничения

- Обрабатывается только одна задача одновременно
- Поддерживаются только видеофайлы (.mkv, .mp4, .avi, .mov, .wmv, .flv, .webm, .m4v)
- Требуется FFmpeg с поддержкой FLAC
- Замена только точного совпадения "DTS-HD.5.1" → "FLAC.7.1"

## Поддержка

Для вопросов и проблем создавайте issue в репозитории.

## Лицензия

MIT License